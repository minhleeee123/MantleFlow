// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum TriggerType {
  BUY
  SELL
}

enum TriggerStatus {
  ACTIVE
  EXECUTED
  CANCELLED
  FAILED
}

enum TransactionType {
  DEPOSIT
  WITHDRAW
  SWAP
}

enum TransactionStatus {
  SUCCESS
  PENDING
  FAILED
}

model User {
  id            String    @id @default(uuid())
  walletAddress String    @unique
  email         String?
  createdAt     DateTime  @default(now())
  
  triggers      Trigger[]
  transactions  Transaction[]
  
  @@index([walletAddress])
}

model Trigger {
  id              String        @id @default(uuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  symbol          String        // MNT, USDT, BTC, ETH, etc
  targetPrice     Float         // Target price (can be 0 for smart triggers)
  condition       String        // ABOVE, BELOW
  amount          Float         // Amount to trade
  type            TriggerType   // BUY, SELL
  
  smartConditions Json?         // AI-generated conditions
  slippage        Float?        @default(5) // Slippage tolerance %
  
  status          TriggerStatus @default(ACTIVE) // ACTIVE, EXECUTED, CANCELLED, FAILED
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  executions      Execution[]
  
  @@index([userId, status])
  @@index([status, createdAt])
}

model Execution {
  id              String        @id @default(uuid())
  triggerId       String
  trigger         Trigger       @relation(fields: [triggerId], references: [id], onDelete: Cascade)
  userId          String        // Add userId for executor service
  
  symbol          String
  amount          Float         // Amount traded
  type            TriggerType   // BUY, SELL
  
  txHash          String?
  details         Json?         // Store swap result and conditions
  
  executedAt      DateTime      @default(now())
  
  @@index([triggerId])
  @@index([userId])
  @@index([executedAt])
}

model Transaction {
  id          String            @id @default(uuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        TransactionType   // DEPOSIT, WITHDRAW, SWAP
  tokenIn     String            // Token input
  tokenOut    String?           // Token output (for swaps)
  amountIn    Float
  amountOut   Float?            // For swaps
  
  txHash      String?
  status      TransactionStatus @default(SUCCESS) // SUCCESS, PENDING, FAILED
  
  createdAt   DateTime          @default(now())
  
  @@index([userId, createdAt])
  @@index([type])
}

model MarketCache {
  id          String   @id @default(uuid())
  cacheKey    String   @unique // e.g., "price_BTC", "rsi_ETH_14", "sentiment"
  data        Json     // Cached data
  expiresAt   DateTime // Expiration timestamp
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([cacheKey, expiresAt])
}
